<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSS Reader – Cloud Sync Edition</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
  .container { max-width: 700px; margin: auto; padding: 12px; }
  .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 4px 0; border-bottom: 1px solid #ddd; }
  .nav-bar a { text-decoration: none; color: #0078ff; font-size: 14px; font-weight: bold; }
  #syncStatus { font-size: 10px; color: #888; margin-left: 8px; }
  mark.custom-highlight { background-color: #ffeb3b; color: #000; padding: 0 1px; border-radius: 2px; }
  select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; background: white; margin-bottom: 10px; }
  .carousel { display: flex; overflow-x: scroll; scroll-snap-type: x mandatory; gap: 10px; padding: 10px 0; -webkit-overflow-scrolling: touch; }
  .slide { min-width: 75%; background: white; padding: 6px; border-radius: 10px; scroll-snap-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.15); height: 120px; display: flex; align-items: center; justify-content: center; }
  .slide img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
  .article { background: white; padding: 20px; margin-top: 12px; border-radius: 12px; line-height: 1.25; font-size: 15px; opacity: 0; animation: fadeIn 0.4s forwards; }
  .article h2 { font-size: 18px; margin-top: 0; line-height: 1.2; }
  .translation-original { margin-bottom: 2px; }
  .translation-line { color: #555; margin: 0 0 8px 10px; font-style: italic; }
  .toggle-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  @keyframes fadeIn { to { opacity: 1; } }
</style>
</head>
<body>

<div class="container">
  <div class="nav-bar">
    <div><strong>Reader</strong><span id="syncStatus"></span></div>
    <a href="woorden.html">Instellingen ⚙️</a>
  </div>

  <div class="toggle-row">
    <input type="checkbox" id="toggleTranslate">
    <label for="toggleTranslate">Vertaling inschakelen</label>
  </div>

  <select id="feedSelect" onchange="loadSelectedFeed()"></select>
  <div id="carousel" class="carousel"></div>
  <div id="article" class="article"></div>
</div>

<script>
let items = [];
let currentIndex = 0;

/* ========= BATCH VERTALING (DeepSeek) ========= */

async function translateSentencesBatch(sentences, targetLang = "pt-BR") {
  try {
    const url = `/api/translate?sentences=${JSON.stringify(sentences)}&target=${targetLang}`;
    const resp = await fetch(url);
    const data = await resp.json();

    if (!resp.ok || !Array.isArray(data.translations)) {
      console.warn("Batch vertaling mislukt:", data);
      return [];
    }

    return data.translations;
  } catch (e) {
    console.error("Batch vertaalfout:", e);
    return [];
  }
}

function splitIntoSentences(text) {
  return text
    .replace(/\s+/g, " ")
    .split(/(?<=[.!?])\s+/)
    .filter(s => s.trim().length > 0);
}

async function translateArticleContent(html, targetLang = "pt-BR") {
  const temp = document.createElement("div");
  temp.innerHTML = html;
  const text = temp.innerText;

  const sentences = splitIntoSentences(text);
  if (sentences.length === 0) return html;

  // --- CHUNKING ---
  const chunkSize = 20;
  const chunks = [];
  for (let i = 0; i < sentences.length; i += chunkSize) {
    chunks.push(sentences.slice(i, i + chunkSize));
  }

  // --- PARALLEL BATCHING ---
  const results = await Promise.all(
    chunks.map(chunk => translateSentencesBatch(chunk, targetLang))
  );

  const translations = results.flat();

  let output = "";
  sentences.forEach((s, i) => {
    output += `<p class="translation-original">${s}</p>`;
    if (translations[i]) {
      output += `<p class="translation-line">${translations[i]}</p>`;
    }
  });

  return output;
}

/* ========= Cloud sync en RSS ========= */

async function fetchCloudData(url) {
  if (!url) return [];
  try {
    const resp = await fetch(url);
    const text = await resp.text();
    return text
      .split(/[\r\n]+/)
      .map(row => row.replace(/^"|"$/g, "").trim())
      .filter(row => row.length > 0);
  } catch (e) {
    console.error("Cloud sync fout:", e);
    return null;
  }
}

async function startSync() {
  const statusEl = document.getElementById("syncStatus");
  statusEl.textContent = "(Syncing...)";

  const wordUrl = localStorage.getItem("syncSheetUrl");
  const feedUrl = localStorage.getItem("syncFeedUrl");

  const [words, feeds] = await Promise.all([
    fetchCloudData(wordUrl),
    fetchCloudData(feedUrl)
  ]);

  if (words) localStorage.setItem("highlightWords", JSON.stringify(words));
  if (feeds) localStorage.setItem("rssFeeds", JSON.stringify(feeds));

  statusEl.textContent = words && feeds ? "(Cloud OK)" : "(Offline mode)";
}

function applyHighlights(html, words) {
  if (!words || words.length === 0) return html;
  const pattern = [...words]
    .sort((a, b) => b.length - a.length)
    .map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
    .join("|");
  const regex = new RegExp(`\\b(${pattern})\\b(?=[^>]*<)`, "gi");
  return html.replace(regex, match => `<mark class="custom-highlight">${match}</mark>`);
}

function loadSavedFeeds() {
  const select = document.getElementById("feedSelect");
  const feeds = JSON.parse(localStorage.getItem("rssFeeds") || "[]");
  select.innerHTML = feeds.map(f => `<option value="${f}">${f}</option>`).join("");
  if (feeds.length > 0) loadFeed(feeds[0]);
}

async function loadFeed(url) {
  const carousel = document.getElementById("carousel");
  carousel.innerHTML = "Laden...";
  try {
    const resp = await fetch(
      `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`
    );
    const data = await resp.json();
    items = data.items || [];
    carousel.innerHTML = items
      .map(
        item =>
          `<div class="slide"><img src="${
            item.thumbnail ||
            (item.enclosure && item.enclosure.link) ||
            "https://via.placeholder.com/150"
          }"></div>`
      )
      .join("");
    loadArticle(0);
  } catch (e) {
    console.error("RSS fout:", e);
    carousel.innerHTML = "Fout bij laden.";
  }
}

function loadSelectedFeed() {
  const url = document.getElementById("feedSelect").value;
  loadFeed(url);
}

async function loadArticle(index) {
  const container = document.getElementById("article");
  container.style.opacity = 0;
  container.innerHTML = "Laden...";
  currentIndex = index;

  try {
    const link = items[index]?.link;
    if (!link) {
      container.innerHTML = "Geen artikel.";
      return;
    }

    const resp = await fetch(`/api/article?url=${encodeURIComponent(link)}`);
    const data = await resp.json();
    const words = JSON.parse(localStorage.getItem("highlightWords") || "[]");

    let html = data.content;
    const title = data.title || "";

    if (document.getElementById("toggleTranslate").checked) {
      html = await translateArticleContent(html, "pt-BR");
    }

    container.innerHTML = `
      <h2>${applyHighlights(title, words)}</h2>
      ${applyHighlights(html, words)}
    `;

    requestAnimationFrame(() => {
      container.style.opacity = 1;
    });
  } catch (e) {
    console.error("Artikel fout:", e);
    container.innerHTML = "Fout.";
  }
}

/* ========= Swipe & init ========= */

document.getElementById("carousel").onscroll = () => {
  const slide = document.querySelector(".slide");
  if (!slide) return;
  const slideWidth = slide.offsetWidth + 10;
  const index = Math.round(document.getElementById("carousel").scrollLeft / slideWidth);
  if (index !== currentIndex && items[index]) {
    currentIndex = index;
    loadArticle(index);
  }
};

async function init() {
  await startSync();
  loadSavedFeeds();
}
init();
</script>
</body>
</html>
